# Safe Wallet API

## Описание

Данный проект реализует REST API для управления кошельками. Он включает основные операции:
- Создание кошелька (в т.ч. с начальным балансом).
- Получение баланса кошелька по UUID.
- Проведение операций с кошельком: пополнение (`DEPOSIT`) и снятие средств (`WITHDRAW`).

Все операции с балансом защищены транзакциями и обеспечивают корректную работу при параллельных запросах.

## Стек технологий

- Python
- Django
- Django REST Framework
- PostgreSQL
- Docker, docker-compose
- Pytest

## Версионирование API

Все эндпоинты доступны по префиксу `/api/v1/`.

## Доступные эндпоинты

| Метод  | URL                                 | Описание                                                        |
|--------|-------------------------------------|-----------------------------------------------------------------|
| `POST` | `/api/v1/wallets/`                  | Создание кошелька (создано в целях тестирования).               |
| `GET`  | `/api/v1/wallets/`                  | Получение списка всех кошельков (создано в целях тестирования). |
| `GET`  | `/api/v1/wallets/<uuid>/`           | Получение баланса кошелька по UUID.                             |
| `POST` | `/api/v1/wallets/<uuid>/operation/` | Проведение операции с кошельком (`DEPOSIT` или `WITHDRAW`).     |

### Пример тела запроса на пополнение или снятие средств

```json
{
  "operation_type": "WITHDRAW",
  "amount": "100.00"
}
```

### Пример ответа

```json
{
  "detail": "Operation with wallet successful.",
  "uuid": "a28f8d6e-87d6-4ad3-bff8-80e1f18a1550",
  "balance": "900.00"
}
```

Если не хватает баланса при `WITHDRAW`:
```json
{
  "detail": "Not enough balance."
}
```

### Пример тела запроса на создание кошелька с балансом

```json
{
  "balance": 1000
}
```

### Пример ответа

```json
{
    "detail": "Wallet created successfully.",
    "uuid": "36ff86f0-f8b0-42ee-ab1e-f0abf2bbb348",
    "balance": 2000.0
}
```

## Транзакции

Для защиты от Race condition используется `@transaction.atomic` и `select_for_update()` при получении объекта кошелька. Это предотвращает одновременное изменение баланса.

## Тестирование

Проект покрыт unit и API тестами. Протестировано поведение при множественных параллельных запросах (многопоточность) и валидация данных.

Для запуска тестов:
```bash
docker exec -it web pytest
```

## Запуск проекта

1. Клонируйте репозиторий:
```bash
git clone https://github.com/ClutchIm/SafeWalletAPI.git
cd src
```

2. Соберите и запустите контейнеры:
```bash
docker compose up --build
```

3. Готово! API доступно по адресу `http://localhost:8000/api/v1/`.

## Проверка соответствия PEP8

Для проверки кода на соответствие PEP8:
```bash
docker exec -it web flake8 .
```

## Примечание

Эндпоинт `/api/v1/wallets/` реализован исключительно для упрощённого тестирования и демонстрации функционала.